# GP3 EBS 存储功能测试 - 部署到 Karpenter 节点
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-gp3-pvc
  namespace: karpenter-test
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
  storageClassName: gp3

---
apiVersion: v1
kind: Pod
metadata:
  name: test-gp3-pod
  namespace: karpenter-test
  labels:
    app: storage-test-karpenter
spec:
  # 指定部署到 Karpenter ARM64 节点
  nodeSelector:
    karpenter.sh/nodepool: nodepool-arm64
  containers:
  - name: test-container
    image: nginx:alpine
    volumeMounts:
    - name: gp3-storage
      mountPath: /data
    command: ["/bin/sh"]
    args: 
    - -c
    - |
      echo "=== GP3 存储测试 (Karpenter 节点) ===" > /data/test.log
      echo "时间: $(date)" >> /data/test.log
      echo "主机名: $(hostname)" >> /data/test.log
      echo "节点信息: $(uname -a)" >> /data/test.log
      
      # 写入测试数据
      for i in {1..50}; do
        echo "测试数据行 $i: $(date +%s%N)" >> /data/test-data.txt
      done
      
      echo "=== 数据写入完成 ===" >> /data/test.log
      echo "文件大小: $(du -h /data/test-data.txt)" >> /data/test.log
      
      # 保持容器运行
      tail -f /data/test.log
  volumes:
  - name: gp3-storage
    persistentVolumeClaim:
      claimName: test-gp3-pvc
